# .github/workflows/gemini-review.yml

name: 'Gemini Code Review'

# è§¦å‘æ¡ä»¶ï¼šå½“æœ‰Pull Requestè¢«åˆ›å»ºã€åŒæ­¥ï¼ˆæœ‰æ–°commitæ¨é€ï¼‰æˆ–é‡æ–°æ‰“å¼€æ—¶
on:
  pull_request:
    types: [opened, synchronize, reopened]

# æƒé™è®¾ç½®ï¼šèµ‹äºˆå·¥ä½œæµå‘Pull Requestå†™å…¥è¯„è®ºçš„æƒé™
permissions:
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ä½¿ç”¨ actions/checkout@v4 æ¥è·å–ä»£ç 
      # fetch-depth: 0 ä¼šè·å–æ‰€æœ‰gitå†å²ï¼Œè¿™å¯¹äºæ¯”è¾ƒåˆ†æ”¯å·®å¼‚è‡³å…³é‡è¦
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 2: è·å–ä»£ç å˜åŠ¨ (Diff)
      # æ¯”è¾ƒå½“å‰PRåˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯ï¼ˆå¦‚ main æˆ– masterï¼‰ä¹‹é—´çš„å·®å¼‚
      - name: Get Code Diff
        id: get_diff
        run: |
          # ä»GitHubäº‹ä»¶ä¸Šä¸‹æ–‡ä¸­è·å–åŸºå‡†åˆ†æ”¯å’Œå¤´éƒ¨åˆ†æ”¯
          BASE_REF="${{ github.base_ref }}"
          HEAD_REF="${{ github.head_ref }}"

          # ä½¿ç”¨git diffå‘½ä»¤ç”Ÿæˆå·®å¼‚ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
          # --no-color ç§»é™¤é¢œè‰²ä»£ç ï¼Œç¡®ä¿çº¯æ–‡æœ¬è¾“å‡º
          git diff "origin/$BASE_REF" "origin/$HEAD_REF" --no-color > changes.diff

          # å°†æ–‡ä»¶å†…å®¹è¯»å…¥ä¸€ä¸ªå˜é‡ï¼Œå¹¶è®¾ç½®ä¸ºGitHub Actionsçš„è¾“å‡ºå˜é‡
          # 'EOF' æ˜¯ä¸€ä¸ªheredocæ ‡è®°ï¼Œç”¨äºå¤„ç†å¤šè¡Œæ–‡æœ¬
          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          cat changes.diff >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 3: è°ƒç”¨ Gemini API è¿›è¡Œä»£ç å®¡æŸ¥
      - name: Call Gemini API for Code Review
        id: gemini_review
        # åªæœ‰åœ¨diffå†…å®¹ä¸ä¸ºç©ºæ—¶æ‰æ‰§è¡Œæ­¤æ­¥éª¤
        if: steps.get_diff.outputs.diff_content != ''
        env:
          # ä»GitHub Secretsä¸­å®‰å…¨åœ°è·å–APIå¯†é’¥
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # æ„é€ ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„Promptï¼ŒæŒ‡å¯¼Geminiè¿›è¡Œé«˜è´¨é‡çš„ä»£ç å®¡æŸ¥
          PROMPT="""
          As an expert senior software engineer, please perform a thorough code review on the following pull request.
          The code changes are provided in the git diff format.

          Your task is to:
          1.  **Identify potential bugs:** Look for logical errors, race conditions, null pointer exceptions, etc.
          2.  **Check for performance issues:** Analyze if the code is inefficient, has memory leaks, or could be optimized.
          3.  **Verify code style and conventions:** Ensure the code adheres to common best practices and is readable and maintainable.
          4.  **Assess security vulnerabilities:** Check for potential security risks like injection attacks, data exposure, etc.
          5.  **Provide actionable suggestions:** For each point you raise, offer a clear, constructive suggestion for improvement, including code snippets if necessary.

          Structure your feedback in Markdown format. Use headings for different categories of feedback (e.g., ### ğŸ› Bugs, ### âš¡ï¸ Performance, ### ğŸ¨ Style).
          If there are no issues, simply respond with "Great work! I found no issues in this pull request."

          Here is the code diff:
          ```diff
          ${{ steps.get_diff.outputs.diff_content }}
          ```
          """

          # ä½¿ç”¨jqå·¥å…·å®‰å…¨åœ°æ„é€ JSON payloadï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          JSON_PAYLOAD=$(jq -n \
            --arg prompt_text "$PROMPT" \
            '{ 
              "contents": [{ 
                "parts": [{ 
                  "text": $prompt_text 
                }]
              }], 
              "generationConfig": {
                "maxOutputTokens": 8192,
                "temperature": 0.4,
                "topP": 1
              },
              "safetySettings": [
                { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
              ]
            }')

          # ä½¿ç”¨curlè°ƒç”¨Gemini 1.5 Pro API
          # -s: silent mode, -X POST: specifies POST request
          # -H: sets header, -d: sends data
          API_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}"
          
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "$API_URL")

          # ä»APIè¿”å›çš„JSONä¸­æå–å®¡æŸ¥æ„è§çš„æ–‡æœ¬å†…å®¹
          REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸæå–åˆ°è¯„è®º
          if [ -z "$REVIEW_COMMENT" ] || [ "$REVIEW_COMMENT" == "null" ]; then
            echo "Failed to get review comment from Gemini API."
            echo "API Response:"
            echo "$RESPONSE"
            exit 1
          fi

          # å°†æœ€ç»ˆçš„å®¡æŸ¥æ„è§è®¾ç½®ä¸ºè¾“å‡ºå˜é‡
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 4: å°†å®¡æŸ¥æ„è§å‘å¸ƒåˆ°Pull Request
      - name: Post Review Comment to PR
        # åªæœ‰åœ¨æˆåŠŸè·å–åˆ°å®¡æŸ¥æ„è§æ—¶æ‰æ‰§è¡Œ
        if: steps.gemini_review.outputs.review_comment != ''
        uses: actions/github-script@v7
        with:
          script: |
            const reviewBody = `### ğŸš€ Gemini 1.5 Pro Code Review\n\n${{ steps.gemini_review.outputs.review_comment }}`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewBody
            });
