# .github/workflows/gemini-review.yml

name: 'Gemini Code Review'

# è§¦å‘æ¡ä»¶ï¼šå½“æœ‰Pull Requestè¢«åˆ›å»ºã€åŒæ­¥ï¼ˆæœ‰æ–°commitæ¨é€ï¼‰æˆ–é‡æ–°æ‰“å¼€æ—¶

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    types: [opened, synchronize, reopened]

# æƒé™è®¾ç½®ï¼šèµ‹äºˆå·¥ä½œæµå‘Pull Requestå†™å…¥è¯„è®ºçš„æƒé™
permissions:
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # ä½¿ç”¨ actions/checkout@v4 æ¥è·å–ä»£ç 
      # fetch-depth: 0 ä¼šè·å–æ‰€æœ‰gitå†å²ï¼Œè¿™å¯¹äºæ¯”è¾ƒåˆ†æ”¯å·®å¼‚è‡³å…³é‡è¦
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 2: è·å–ä»£ç å˜åŠ¨ (Diff)
      # æ¯”è¾ƒå½“å‰PRåˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯ï¼ˆå¦‚ main æˆ– masterï¼‰ä¹‹é—´çš„å·®å¼‚
      - name: Get Code Diff
        id: get_diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.base_ref }}"
            HEAD_REF="${{ github.head_ref }}"
            # ç›´æ¥å°è¯• fetch å¹¶ diffï¼Œè‹¥åˆ†æ”¯ä¸å­˜åœ¨åˆ™è·³è¿‡
            git fetch origin "$BASE_REF" || true
            git fetch origin "$HEAD_REF" || true
            if git rev-parse --verify "origin/$BASE_REF" >/dev/null 2>&1 && git rev-parse --verify "origin/$HEAD_REF" >/dev/null 2>&1; then
              git diff "origin/$BASE_REF" "origin/$HEAD_REF" --no-color > changes.diff
            else
              echo "æ— æ³•æ‰¾åˆ°åŸºå‡†åˆ†æ”¯æˆ–å¤´éƒ¨åˆ†æ”¯ï¼Œè·³è¿‡ diff ç”Ÿæˆã€‚" > changes.diff
            fi
          else
            # push äº‹ä»¶ï¼Œç¡®ä¿æœ‰ä¸¤ä¸ªæäº¤å¯æ¯”è¾ƒ
            if [ $(git rev-list --count HEAD) -ge 2 ]; then
              git diff HEAD^ HEAD --no-color > changes.diff
            else
              # é¦–æ¬¡æäº¤æˆ–åªæœ‰ä¸€ä¸ªæäº¤ï¼Œæ— æ³• diff
              echo "é¦–æ¬¡æäº¤æˆ–åªæœ‰ä¸€ä¸ªæäº¤ï¼Œæ— æ³•ç”Ÿæˆ diffã€‚" > changes.diff
            fi
          fi

          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          cat changes.diff >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      # æ­¥éª¤ 3: è°ƒç”¨ Gemini API è¿›è¡Œä»£ç å®¡æŸ¥
      - name: Call Gemini API for Code Review
        id: gemini_review
        if: steps.get_diff.outputs.diff_content != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PROMPT="""
          As an expert senior software engineer, please perform a thorough code review on the following code changes.
          The code changes are provided in the git diff format.

          Your task is to:
          1.  **Identify potential bugs:** Look for logical errors, race conditions, null pointer exceptions, etc.
          2.  **Check for performance issues:** Analyze if the code is inefficient, has memory leaks, or could be optimized.
          3.  **Verify code style and conventions:** Ensure the code adheres to common best practices and is readable and maintainable.
          4.  **Assess security vulnerabilities:** Check for potential security risks like injection attacks, data exposure, etc.
          5.  **Provide actionable suggestions:** For each point you raise, offer a clear, constructive suggestion for improvement, including code snippets if necessary.

          Structure your feedback in Markdown format. Use headings for different categories of feedback (e.g., ### ğŸ› Bugs, ### âš¡ï¸ Performance, ### ğŸ¨ Style).
          If there are no issues, simply respond with "Great work! I found no issues in this pull request."

          Here is the code diff:
          ```diff
          ${{ steps.get_diff.outputs.diff_content }}
          ```
          """

          JSON_PAYLOAD=$(jq -n \
            --arg prompt_text "$PROMPT" \
            '{ 
              "contents": [{ 
                "parts": [{ 
                  "text": $prompt_text 
                }]
              }], 
              "generationConfig": {
                "maxOutputTokens": 8192,
                "temperature": 0.4,
                "topP": 1
              },
              "safetySettings": [
                { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
                { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
                { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
                { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
              ]
            }')

          API_URL="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}"
          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "$API_URL")

          REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          if [ -z "$REVIEW_COMMENT" ] || [ "$REVIEW_COMMENT" == "null" ]; then
            echo "Failed to get review comment from Gemini API."
            echo "API Response:"
            echo "$RESPONSE"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰è‡´å‘½é”™è¯¯ï¼Œè‹¥æœ‰åˆ™æ‹’ç» push/PR
          if echo "$REVIEW_COMMENT" | grep -E 'fatal|è‡´å‘½|ä¸¥é‡é”™è¯¯|blocker|é˜»æ–­'; then
            echo "âŒ æ£€æŸ¥åˆ°è‡´å‘½é”™è¯¯ï¼Œæ‹’ç»æ­¤æ¬¡ push/PRã€‚"
            exit 1
          fi

          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      # æ­¥éª¤ 4: ä»…åœ¨PRäº‹ä»¶æ—¶å‘å¸ƒè¯„è®º
      - name: Post Review Comment to PR
        if: github.event_name == 'pull_request' && steps.gemini_review.outputs.review_comment != ''
        uses: actions/github-script@v7
        with:
          script: |
            const reviewBody = `### ğŸš€ Gemini 1.5 Pro Code Review\n\n${{ steps.gemini_review.outputs.review_comment }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewBody
            });
