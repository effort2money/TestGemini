name: AI Code Review with Gemini Pro 2.5

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¾ æ‹‰å–ä»£ç ä»“åº“
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: ğŸ å®‰è£… Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–åº“
      run: pip install requests

    - name: ğŸ§© è·å–å½“å‰ PR çš„ä»£ç å·®å¼‚
      run: |
        git diff origin/${{ github.base_ref }}...HEAD > diff.txt || echo "" > diff.txt

    - name: ğŸ¤– æ‰§è¡Œ Gemini AI ä»£ç å®¡æŸ¥
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/scripts/code_review.py

    - name: ğŸ’¬ æ·»åŠ  Gemini Inline è¡Œè¯„è®º
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require("fs");
          const comments = JSON.parse(fs.readFileSync("inline_comments.json", "utf8"));
          const prNumber = context.payload.pull_request.number;
          const headSha = context.payload.pull_request.head.sha;

          for (const comment of comments) {
            try {
              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                commit_id: headSha,
                path: comment.path,
                position: comment.position,
                body: comment.body
              });
            } catch (e) {
              console.log("âŒ è¯„è®ºå¤±è´¥:", comment.path, comment.position, e.message);
            }
          }

    - name: ğŸ“ æ·»åŠ  PR é¡¶éƒ¨æ€»ç»“è¯„è®º
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require("fs");
          const body = fs.readFileSync("review_output.txt", "utf8");
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body
          });
